<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundation Shade Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            color: #6a4c93;
            margin-bottom: 0.5rem;
        }
        .upload-section {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .camera-section {
            display: none;
            text-align: center;
            margin-bottom: 1rem;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        #canvas {
            display: none;
        }
        .preview-container {
            text-align: center;
            margin: 1rem 0;
        }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        .results-section {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .results-section h2 {
            color: #6a4c93;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .skin-tone-display {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .color-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-right: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .skin-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .recommendations {
            margin-top: 2rem;
        }
        .foundation-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        .foundation-card:hover {
            transform: translateY(-3px);
        }
        .foundation-color {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 1rem;
        }
        .undertone-tag {
            display: inline-block;
            background-color: #ffcb77;
            color: #333;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner-border {
            color: #6a4c93;
        }
        .btn-primary {
            background-color: #6a4c93;
            border-color: #6a4c93;
        }
        .btn-primary:hover {
            background-color: #5a3d7a;
            border-color: #5a3d7a;
        }
        .btn-secondary {
            background-color: #8ac6d1;
            border-color: #8ac6d1;
            color: #333;
        }
        .btn-secondary:hover {
            background-color: #6db5c3;
            border-color: #6db5c3;
            color: #333;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            margin: 1rem 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Foundation Shade Finder</h1>
            <p>Upload your photo or use your camera to find your perfect foundation match</p>
        </div>
        
        <div class="upload-section">
            <div class="d-flex justify-content-center mb-3">
                <button id="uploadBtn" class="btn btn-primary me-2">Upload Photo</button>
                <button id="cameraBtn" class="btn btn-secondary">Use Camera</button>
                <input type="file" id="fileInput" accept="image/*" hidden>
            </div>
            
            <div class="camera-section" id="cameraSection">
                <div style="position: relative; display: inline-block;">
                    <video id="video" autoplay playsinline></video>
                    <div class="face-overlay">
                        <svg width="200" height="240" viewBox="0 0 200 240">
                            <ellipse cx="100" cy="120" rx="70" ry="90" stroke="#6a4c93" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                        </svg>
                    </div>
                </div>
                <canvas id="canvas" width="400" height="300"></canvas>
                <button id="captureBtn" class="btn btn-primary">Capture Photo</button>
            </div>
            
            <div class="preview-container" id="previewContainer" style="display: none;">
                <img id="imagePreview" alt="Preview">
                <div class="mt-3">
                    <button id="analyzeBtn" class="btn btn-primary">Analyze Face</button>
                    <button id="resetBtn" class="btn btn-secondary ms-2">Reset</button>
                </div>
            </div>
            
            <div class="loading" id="loadingIndicator">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Analyzing your skin tone...</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <h2>Your Results</h2>
            
            <div class="skin-tone-display">
                <div class="color-circle" id="skinToneColor"></div>
                <div class="skin-info">
                    <h4>Detected Skin Tone</h4>
                    <p id="itaValue"></p>
                    <p id="undertoneValue"></p>
                    <p id="mstLevel"></p>
                </div>
            </div>
            
            <div class="recommendations">
                <h3>Recommended Foundation Shades</h3>
                <div id="recommendationsList"></div>
            </div>
            
            <div class="mt-4 text-center">
                <button id="adjustLighterBtn" class="btn btn-sm btn-secondary me-1">A Touch Lighter</button>
                <button id="adjustDarkerBtn" class="btn btn-sm btn-secondary me-1">A Touch Deeper</button>
                <button id="adjustNeutralBtn" class="btn btn-sm btn-secondary me-1">Try Neutral</button>
                <button id="adjustWarmBtn" class="btn btn-sm btn-secondary me-1">Try Warm</button>
                <button id="adjustCoolBtn" class="btn btn-sm btn-secondary">Try Cool</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraSection = document.getElementById('cameraSection');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const skinToneColor = document.getElementById('skinToneColor');
        const itaValue = document.getElementById('itaValue');
        const undertoneValue = document.getElementById('undertoneValue');
        const mstLevel = document.getElementById('mstLevel');
        const recommendationsList = document.getElementById('recommendationsList');
        const adjustLighterBtn = document.getElementById('adjustLighterBtn');
        const adjustDarkerBtn = document.getElementById('adjustDarkerBtn');
        const adjustNeutralBtn = document.getElementById('adjustNeutralBtn');
        const adjustWarmBtn = document.getElementById('adjustWarmBtn');
        const adjustCoolBtn = document.getElementById('adjustCoolBtn');
        
        // Variables
        let selectedImage = null;
        let stream = null;
        let currentResults = null;
        
        // Event Listeners
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        cameraBtn.addEventListener('click', toggleCamera);
        captureBtn.addEventListener('click', capturePhoto);
        analyzeBtn.addEventListener('click', analyzeFace);
        resetBtn.addEventListener('click', resetUI);
        
        // Adjustment buttons
        adjustLighterBtn.addEventListener('click', () => adjustResults('lighter'));
        adjustDarkerBtn.addEventListener('click', () => adjustResults('darker'));
        adjustNeutralBtn.addEventListener('click', () => adjustResults('neutral'));
        adjustWarmBtn.addEventListener('click', () => adjustResults('warm'));
        adjustCoolBtn.addEventListener('click', () => adjustResults('cool'));
        
        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                selectedImage = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = 'block';
                    cameraSection.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Toggle camera
        async function toggleCamera() {
            if (cameraSection.style.display === 'none' || cameraSection.style.display === '') {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    cameraSection.style.display = 'block';
                    previewContainer.style.display = 'none';
                } catch (err) {
                    showError('Could not access camera. Please allow camera access or use the upload option.');
                    console.error('Error accessing camera:', err);
                }
            } else {
                stopCamera();
                cameraSection.style.display = 'none';
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        // Capture photo from camera
        function capturePhoto() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(blob => {
                selectedImage = new File([blob], "camera-capture.jpg", { type: "image/jpeg" });
                imagePreview.src = canvas.toDataURL('image/jpeg');
                previewContainer.style.display = 'block';
                cameraSection.style.display = 'none';
                stopCamera();
            }, 'image/jpeg');
        }
        
        // Analyze face
        async function analyzeFace() {
            if (!selectedImage) {
                showError('Please select or capture an image first.');
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            resultsSection.style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('file', selectedImage);
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to analyze image');
                }
                
                const data = await response.json();
                currentResults = data;
                displayResults(data);
                
            } catch (error) {
                showError(error.message || 'Error analyzing face. Please try again with a clearer photo.');
                console.error('Error analyzing face:', error);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Display results
        function displayResults(data) {
            // Set skin tone color
            const [L, a, b] = data.user_lab;
            skinToneColor.style.backgroundColor = labToHex(L, a, b);
            
            // Set text values
            itaValue.textContent = `ITA: ${data.ITA}Â°`;
            undertoneValue.textContent = `Undertone: ${capitalizeFirstLetter(data.undertone)}`;
            mstLevel.textContent = `MST Level: ${data.mst_level}`;
            
            // Display recommendations
            recommendationsList.innerHTML = '';
            data.recommendations.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'foundation-card';
                
                // Convert LAB to hex for display
                const recColor = document.createElement('div');
                recColor.className = 'foundation-color';
                
                // Use the brand's color if available, otherwise use a placeholder
                recColor.style.backgroundColor = '#D8B390'; // Placeholder color
                
                const recInfo = document.createElement('div');
                recInfo.className = 'foundation-info';
                
                const brandName = document.createElement('strong');
                brandName.textContent = rec.brand;
                
                const shadeName = document.createElement('span');
                shadeName.textContent = ` ${rec.shade}`;
                
                const undertoneTag = document.createElement('span');
                undertoneTag.className = 'undertone-tag';
                undertoneTag.textContent = capitalizeFirstLetter(rec.undertone);
                
                const deltaE = document.createElement('div');
                deltaE.className = 'small text-muted';
                deltaE.textContent = `Match score: ${(100 - rec.deltaE * 10).toFixed(0)}%`;
                
                recInfo.appendChild(brandName);
                recInfo.appendChild(shadeName);
                recInfo.appendChild(undertoneTag);
                recInfo.appendChild(deltaE);
                
                card.appendChild(recColor);
                card.appendChild(recInfo);
                
                recommendationsList.appendChild(card);
            });
            
            // Show results section
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Adjust results based on user feedback
        function adjustResults(adjustment) {
            // In a real implementation, this would send the adjustment to the server
            // For now, we'll just show a message
            alert(`Adjustment '${adjustment}' would be sent to the server in a real implementation.`);
        }
        
        // Reset UI
        function resetUI() {
            selectedImage = null;
            imagePreview.src = '';
            previewContainer.style.display = 'none';
            resultsSection.style.display = 'none';
            errorMessage.style.display = 'none';
            fileInput.value = '';
        }
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Convert LAB to hex (simplified)
        function labToHex(L, a, b) {
            // This is a very simplified conversion
            // In a real implementation, use a proper color conversion library
            const rgb = labToRgb(L, a, b);
            return rgbToHex(rgb.r, rgb.g, rgb.b);
        }
        
        // Simplified LAB to RGB conversion
        function labToRgb(L, a, b) {
            // This is a placeholder - not accurate
            // In a real implementation, use a proper color conversion library
            return {
                r: Math.min(255, Math.max(0, Math.round(L * 2.55 + a))),
                g: Math.min(255, Math.max(0, Math.round(L * 2.55))),
                b: Math.min(255, Math.max(0, Math.round(L * 2.55 - b)))
            };
        }
        
        // Convert RGB to hex
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = Math.round(x).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }
    </script>
</body>
</html>